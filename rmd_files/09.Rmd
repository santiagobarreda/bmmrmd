\newpage
```{r, include = FALSE}
knitr::opts_chunk$set(
  dpi = 600, dev = "jpeg", collapse=TRUE, options(digits=4)
)
rm (list=ls())
```

# Quantitative predictors and their interactions with factors

## Chapter pre-cap

## Data and research questions 

```{r, warning=FALSE, message=FALSE}
library (brms)
library (bmmb)

data (exp_data)

options (contrasts = c('contr.sum','contr.sum'))

# make a copy of the VTL predictor and center it
exp_data$vtl_original = exp_data$vtl
exp_data$vtl = exp_data$vtl - mean(exp_data$vtl)
```

## Modeling variation along lines

$$
\begin{equation}
\begin{split}
y = a + b \cdot x 
\end{split}
(\#eq:9-1)
\end{equation}
$$

$$
\begin{equation}
\mu = \mathrm{Intercept} + \mathrm{slope} \cdot x 
(\#eq:9-2)
\end{equation}
$$

```{r F9-1, fig.height = 2.75, fig.width = 8, fig.cap = "(left) Average apparent height plotted against speaker vocal-tract length (VTL) for each token. The horizontal line is at the mean of the observations. (middle) The same points as generated by a normal distribution that slides along a horizontal line with a slope of 0 along the VTL axis. (right) The same points as generated by a normal distribution that slides along a line with a non-zero slope.", echo = FALSE}

################################################################################
### Figure 9.1
################################################################################

#library (bmmb)
#data (exp_data)
options (contrasts = c('contr.sum','contr.sum'))

tmp = as.numeric(exp_data$L) * 0 
count=1
for (i in c(15,2,1,14,3,13,4,12,5,6,11,10,8,7,9)){
  tmp[as.numeric(exp_data$L)==i] = count 
  count = count + 1
}
exp_data$L = tmp

Cs = c('b','g','m','w')[apply (table (exp_data$S, exp_data$C), 1, which.max)]
aggd = aggregate (height ~ vtl_original + S, data = exp_data, FUN=mean)
aggd$Cs = Cs

par (mfrow = c(1,3), mar = c(4,.5,.1,.5), oma = c(1,4,1,1))
plot (height ~ vtl_original, data = aggd, ylim = c(135,185),xlim = c(11,16.5), 
      pch=16,col=yellow, xlab="", ylab = "Height (cm)",cex.axis=1.2) 
abline (h = mean (aggd$height), col=deepgreen, lwd=4)
grid()
mtext (side=2,text="Apparent Height (cm)", cex = 1, outer = FALSE, line = 3)

#plot (height ~ vtl, data=aggd, ylim=c(135,185), xlim=c(11,16.5),ylab = "Height (cm)", 
#      pch=16,col=bmmb::cols[c(4,5,3,6)][factor(aggd$C)], xlab="Vocal-Tract Length (cm)") 
#abline (h = tapply (aggd$height, factor(aggd$C), mean), col=cols[c(4,5,3,6)], lwd=4)

#par (mfrow = c(1,2), mar = c(4,4,1,1))
plot (height ~ vtl_original, data = aggd, pch=16,col=yellow, cex=1, ylim = c(135,185),
      yaxt='n', xlab = "Vocal-tract Length (cm)",cex.lab=1.3,cex.axis=1.2 )
abline (h= mean (aggd$height), col=deepgreen, lwd=3)
grid()

for (i in seq(11.25,16,1.25)){
  mu =  mean (aggd$height)
  y = seq(mu-11*2,mu+11*2,.1)
  x = dnorm (y ,mu, 11)
  x = x / max (x) * 0.7
  points (i, mu, cex=2.5, pch=16,col=lavender)
  lines (i+x-.1,y, lwd=2, col=lavender)
}

plot (height ~ vtl_original, data = aggd, pch=16,col=yellow, cex=1, ylim = c(135,185),
      yaxt='n',xlab="",cex.axis=1.2 )
cffs = lm(height ~ vtl_original,data=aggd)$coefficients
abline (cffs,col=deepgreen,lwd=3); 
#abline (h=162, col=deepgreen, lwd=3)
grid()

for (i in seq(11.25,16,1.25)){
  mu = cffs[1] + i * cffs[2]
  y = seq(mu-4*2.5,mu+4*2.5,.1)
  x = dnorm (y ,mu, 4)
  x = x / max (x) * 0.7
  points (i, mu, cex=2.5, pch=16,col=lavender)
  lines (i+x-.1,y, lwd=2, col=lavender)
}
```

$$
\begin{equation}
\begin{split}
\mathrm{Intercept} = 160, \; \mathrm{slope} = 0 \\ \\
\mu = \mathrm{Intercept} + \mathrm{slope} \cdot \mathrm{vtl} \\ 
\mu = \mathrm{Intercept} + 0 \cdot \mathrm{vtl} \\
\mu = \mathrm{Intercept} 
\end{split}
(\#eq:9-3)
\end{equation}
$$

$$
\begin{equation}
\begin{split}
r_{[i]} = (\mathrm{Intercept} + \mathrm{slope} \cdot \mathrm{vtl}_{[i]}) - height_{[i]}
\end{split}
(\#eq:9-4)
\end{equation}
$$

### Description of the model

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{N}(\mu_{[i]},\sigma) \\
\mu_{[i]} = \mathrm{Intercept} + VTL \cdot \mathrm{vtl}_{[i]}  \\ \\
\textrm{Priors:} \\
\mathrm{Intercept} \sim \mathrm{t}(3, 160, 12) \\
VTL \sim \mathrm{t}(3, 0, 12) \\
\sigma \sim \mathrm{t}(3, 0, 12)
\end{split}
(\#eq:9-5)
\end{equation}
$$

$$
\begin{equation}
height_{[i]} = \mathrm{Intercept} + VTL \cdot \mathrm{vtl_{[i]}} + \mathrm{N}(0,\sigma)
(\#eq:9-6)
\end{equation}
$$

$$
\begin{equation}
height_{[i]} = \mathrm{N} (\mathrm{Intercept} + VTL \cdot \mathrm{vtl_{[i]}},\, \sigma)
(\#eq:9-7)
\end{equation}
$$

### Centering quantitative predictors {#c9-centering}

```{r F9-2, fig.height = 2.75, fig.width = 8, fig.cap = "(left) Individual apparent height judgments plotted against speaker vocal-tract length (VTL). (middle) The same points as in the left plot, but focused on the region containing the observations. (right) The same points as in the middle, but plotted according to centered VTL. In each plot, the horizontal line represents the mean of the points and the vertical line represents the y intercept.", echo = FALSE}

################################################################################
### Figure 9.2
################################################################################

#single_line_model_coefficients = fixef (single_line_model)[,1]

cffs = lm(height~vtl_original, data = exp_data)$coefficients

par (mfrow = c(1,3), mar = c(4,2,1,1), oma = c(2,3,0,0))

plot (height ~ vtl_original, data = exp_data, pch=16,col=4,xlim = c(-3,20),
      ylim=c(40,200), xlab="VTL (cm)",cex.lab=1.3,cex.axis=1.2);
abline (cffs,col=2,lwd=3); 
abline (h=mean(exp_data$height), v=0, lty=3)
mtext (side=2, text="Apparent Height (cm)", line = 3)

cffs = lm(height~vtl_original, data = exp_data)$coefficients
plot (height ~ vtl_original, data = exp_data, pch=16,col=4,xlim = c(10,17),
      ylim=c(100,200), xlab="VTL (cm)",cex.lab=1.3,cex.axis=1.2);
abline (cffs,col=2,lwd=3); 
abline (h=mean(exp_data$height), v=0, lty=3)

cffs = lm(height~vtl, data = exp_data)$coefficients
exp_data$vtl_c = exp_data$vtl - mean(exp_data$vtl)
cffs = lm(height~vtl_c, data = exp_data)$coefficients
plot (height ~ vtl_c, data = exp_data, pch=16,col=4,xlim = c(-3.5,3.5),
      ylim=c(100,200), xlab="Centered VTL (cm)",cex.lab=1.3,cex.axis=1.2);
abline (cffs,col=2,lwd=3); 
abline (h=mean(exp_data$height), v=0, lty=3)
```

### Fitting an interpreting the model

```{r, eval = FALSE}
# Fit the model yourself
model_single_line =
  brm (height ~ vtl, data = exp_data, chains=1, cores=1,  
       warmup=1000, iter = 6000,
       prior = c(set_prior("student_t(3, 160, 12)", class = "Intercept"),
                 set_prior("student_t(3, 0, 12)", class = "b"),
                 set_prior("student_t(3, 0, 12)", class = "sigma")))
```
```{r, include = TRUE, eval = FALSE}
# Or download it from the GitHub page:
model_single_line = bmmb::get_model ('9_model_single_line.RDS')
```
```{r, include = FALSE}
# saveRDS (model_single_line, '../models/9_model_single_line.RDS')
model_single_line = readRDS ('../models/9_model_single_line.RDS')
```

```{r, collapse = TRUE}
bmmb::short_summary (model_single_line)
```    

```{r F9-3, fig.height = 2.75, fig.width = 8, fig.cap = "(left) Apparent speaker height plotted against speaker VTL for each data point. The line represents the linear relationship between apparent height and VTL for all points. Point colors represent speaker classifications. (middle) The same points as in the left plot. The horizontal lines represent category-dependent lines all constrained to have a slope of zero. The blue line represents the overall intercept. (right) The same points as in the left plot. The lines represent category-dependent lines with shared (but non-zero) slopes. The blue line represents the overall line.", echo = FALSE}

################################################################################
### Figure 9.3
################################################################################

#single_line_model_coefficients = fixef (single_line_model)[,1]

cffs_one = lm(height~vtl, data = exp_data)$coefficients
cols_use = bmmb::cols[as.numeric(factor(exp_data$C))+1]

par (mfrow = c(1,3), mar = c(1,.1,1,.5), oma = c(3,4,0,0))

exp_data$vtl = exp_data$vtl - mean(exp_data$vtl)

plot (height ~ vtl, data = exp_data, pch=16,col=cols_use,xlim = c(-2.5,3),
      ylim=c(105,195), xlab="Centered VTL (cm)",cex.lab=1.3,cex.axis=1.2);
grid()
abline (cffs_one[1],cffs_one[2],col=4,lwd=3); 
mtext (side = 2, 'Apparent Height (cm)', line = 3)
mtext (side = 1, 'Centered VTL (cm)', outer = TRUE, line = 2)

legend (1,140,legend=c("boy","girl","man","woman"),col=bmmb::cols[2:5],pch=16,bty='n',
        cex=1.3,pt.cex=1.5)

cffs = lm(height~C, data = exp_data)$coefficients
cffs = c(cffs, -sum(cffs[2:4]))

plot (height ~ vtl, data = exp_data, pch=16,col=cols_use,xlim = c(-2.5,3),
      ylim=c(105,195), xlab="Centered VTL (cm)",cex.lab=1.3,yaxt='n',cex.axis=1.2);
grid()
abline (cffs[1],0,col=4,lwd=3); 
abline (cffs[1]+cffs[2],0,col=bmmb::cols[2],lwd=4); 
abline (cffs[1]+cffs[3],0,col=bmmb::cols[3],lwd=4); 
abline (cffs[1]+cffs[4],0,col=bmmb::cols[4],lwd=4); 
abline (cffs[1]+cffs[5],0,col=bmmb::cols[5],lwd=4); 


cffs = lm(height~vtl+C, data = exp_data)$coefficients
cffs = c(cffs, -sum(cffs[3:5]))

plot (height ~ vtl, data = exp_data, pch=16,col=cols_use,xlim = c(-2.5,3),
      ylim=c(105,195), xlab="Centered VTL (cm)",cex.lab=1.3,yaxt='n',cex.axis=1.2);
grid()
abline (cffs[1],cffs[2],col=4,lwd=3,lty=1); 
abline (cffs[1]+cffs[3],cffs[2],col=bmmb::cols[2],lwd=4); 
abline (cffs[1]+cffs[4],cffs[2],col=bmmb::cols[3],lwd=4); 
abline (cffs[1]+cffs[5],cffs[2],col=bmmb::cols[4],lwd=4); 
abline (cffs[1]+cffs[6],cffs[2],col=bmmb::cols[5],lwd=4); 

```

## Models with group-dependent intercepts, but shared slopes

### Description of the model

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{N}(\mu_{[i]},\sigma) \\
\mu_{[i]} = \mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]} + VTL \cdot \mathrm{vtl}_{[i]}  \\ \\
\textrm{Priors:} \\
\mathrm{Intercept} \sim \mathrm{t}(3, 160, 12) \\
VTL \sim \mathrm{t}(3, 0, 12) \\
C_{[\bullet]} \sim \mathrm{t}(3,0,12) \\
\sigma \sim \mathrm{t}(3, 0, 12) 
\end{split}
(\#eq:9-8)
\end{equation}
$$

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{N}(\mu_{[i]},\sigma) \\
\mu_{[i]} = a_{[i]} + b_{[i]} \cdot \mathrm{vtl}_{[i]}  \\ 
a_{[i]} = \mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]} \\
b_{[i]} = VTL \\ \\
\textrm{Priors:} \\
\mathrm{Intercept} \sim \mathrm{t}(3, 160, 12) \\
VTL \sim \mathrm{t}(3, 0, 12) \\
C_{[\bullet]} \sim \mathrm{t}(3,0,12) \\
\sigma \sim \mathrm{t}(3, 0, 12) 
\end{split}
(\#eq:9-9)
\end{equation}
$$

### Fitting and interpreting the model

```{r, eval = FALSE}
# Fit the model yourself
model_many_intercept_one_slope =
  brm (height ~ C + vtl, 
       data=exp_data, chains=1,cores=1,warmup=1000,iter=6000,
       prior = c(set_prior("student_t(3, 160, 12)", class = "Intercept"),
                 set_prior("student_t(3, 0, 12)", class = "b"),
                 set_prior("student_t(3, 0, 12)", class = "sigma")))
```
```{r, include = TRUE, eval = FALSE}
# Or download it from the GitHub page:
model_many_intercept_one_slope = 
  bmmb::get_model ('9_model_many_intercept_one_slope.RDS')
```
```{r, include = FALSE}
# saveRDS (model_many_intercept_one_slope, '9_model_many_intercept_one_slope.RDS')
model_many_intercept_one_slope = 
  readRDS ('../models/9_model_many_intercept_one_slope.RDS')
```

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{N}(\mu_{[i]},\sigma) \\
\mu_{[i]} = a_{[i]} + b_{[i]} \cdot \mathrm{vtl}_{[i]}  \\ 
a_{[i]} = \mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]} \\
b_{[i]} = 0
\end{split}
(\#eq:9-10)
\end{equation}
$$

```{r, eval = FALSE}
# Fit the model yourself
model_many_intercept_no_slope =
 brm (height ~ C, 
       data=exp_data, chains=1,cores=1,warmup=1000,iter=6000,
       prior = c(set_prior("student_t(3, 160, 12)", class = "Intercept"),
                 set_prior("student_t(3, 0, 12)", class = "b"),
                 set_prior("student_t(3, 0, 12)", class = "sigma")))
```
```{r, include = TRUE, eval = FALSE}
# Or download it from the GitHub page:
model_many_intercept_no_slope = 
  bmmb::get_model ('9_model_many_intercept_no_slope.RDS')
```
```{r, include = FALSE}
# saveRDS (model_many_intercept_no_slope, '9_model_many_intercept_no_slope.RDS')
model_many_intercept_no_slope = 
  readRDS ('../models/9_model_many_intercept_no_slope.RDS')
```

```{r, cache = TRUE, collapse = TRUE, echo = TRUE}
many_intercept_no_slope_hypothesis = bmmb::short_hypothesis (
  model_many_intercept_no_slope,
  hypothesis = 
    c("Intercept = 0",               # overall intercept
      "Intercept + C1 = 0",          # group 1 intercept
      "Intercept + C2 = 0",          # group 2 intercept
      "Intercept + C3 = 0",          # group 3 intercept
      "Intercept -(C1+C2+C3) = 0"))  # group 4 intercept

many_intercept_no_slope_hypothesis
```

```{r, cache = TRUE, echo = TRUE}
many_intercept_one_slope_hypothesis = bmmb::short_hypothesis (
  model_many_intercept_one_slope,
  hypothesis = 
    c("Intercept = 0",              # overall intercept
      "Intercept + C1 = 0",         # group 1 intercept
      "Intercept + C2 = 0",         # group 2 intercept
      "Intercept + C3 = 0",         # group 3 intercept
      "Intercept + -(C1+C2+C3)=0",  # group 4 intercept
      "vtl = 0"))                   # overall slope
     
many_intercept_one_slope_hypothesis
```

### Interpreting group effects in the presence of shared (non-zero) slopes

```{r, cache = TRUE, collapse = TRUE}
group_no_slope_effects = bmmb::short_hypothesis (
  model_many_intercept_no_slope,
  hypothesis = c("C1 = 0",              # group 1 effect
                 "C2 = 0",              # group 2 effect
                 "C3 = 0",              # group 3 effect
                 "-(C1+C2+C3) = 0"))    # group 4 effect   
group_no_slope_effects
```


```{r, cache = TRUE, collapse = TRUE}
group_single_slope_effects = bmmb::short_hypothesis (
  model_many_intercept_one_slope,
  hypothesis = c("C1 = 0",             # group 1 effect
                 "C2 = 0",             # group 2 effect
                 "C3 = 0",             # group 3 effect
                 "-(C1+C2+C3) = 0"))   # group 4 effect   
  
group_single_slope_effects
```

```{r F9-4, fig.width = 8, fig.height = 3, echo = FALSE, fig.cap ="(left) Comparison of estimated group effects for the models with and without the VTL predictor. (middle) Lines reflect the triangle coefficients in the left plot. (right) Lines reflect the circle coefficients in the left plot."}

################################################################################
### Figure 9.4
################################################################################

vtl_c = exp_data$vtl - mean (exp_data$vtl) 
cffs_one = lm(height~vtl, data = exp_data)$coefficients
cols_use = bmmb::cols[as.numeric(factor(exp_data$C))+1]

par (mfrow = c(1,3), mar = c(4,.1,3,.5), oma = c(0,4,0,0))

brmplot (group_no_slope_effects, col = bmmb::cols[2:5], ylim = c(-15,18),cex=3,pch=2,
         labels = c("boys","girls","men","women"),ylab="f0 Effect (Hz)", 
         nudge = -.1, xlim = c(.75,4.25),cex.lab=1.3,cex.axis=1.3)
brmplot (group_single_slope_effects, add = TRUE, col = bmmb::cols[2:5],
         labels="", nudge = .1, cex=3,pch=1)
abline (h=0,lty=1); 
mtext (side=2,"Centimeters", outer = TRUE, line = 2.5)

legend (1,15, legend =c("No VTL","With VTL"), pch = 17:16, bty = 'n',
        cex=1.3, pt.cex=1.8)

cffs = lm(height~C, data = exp_data)$coefficients
cffs = c(cffs, -sum(cffs[2:4]))

plot (height ~ vtl_c, data = exp_data, pch=16,col=cols_use,
      ylim=c(-15,18), xlab="Centered VTL (cm)",cex.axis=1.3,
      cex.lab=1.3,yaxt='n',type='n', xlim = c(-3,3),main = "No VTL");
grid()
abline (h=0,lty=1); 
abline (cffs[2],0,col=bmmb::cols[2],lwd=4); 
abline (cffs[3],0,col=bmmb::cols[3],lwd=4); 
abline (cffs[4],0,col=bmmb::cols[4],lwd=4); 
abline (cffs[5],0,col=bmmb::cols[5],lwd=4); 

cffs = lm(height~vtl+C, data = exp_data)$coefficients
cffs = c(cffs, -sum(cffs[3:5]))

plot (height ~ vtl_c, data = exp_data, pch=16,col=cols_use,
      ylim=c(-15,18), xlab="Centered VTL (cm)",cex.axis=1.3,
      cex.lab=1.3,yaxt='n', xlim = c(-3,3),main = "With VTL");
grid()
abline (h=0,lty=1); 
abline (cffs[3],0,col=bmmb::cols[2],lwd=4); 
abline (cffs[4],0,col=bmmb::cols[3],lwd=4); 
abline (cffs[5],0,col=bmmb::cols[4],lwd=4); 
abline (cffs[6],0,col=bmmb::cols[5],lwd=4); 

legend (-2,16, legend =c("b","g","m","w"), pch=15, bty = 'n',
        cex=1.3, pt.cex=1.8, col = bmmb::cols[2:5], horiz =TRUE)

```

## Models with group-dependent slopes and intercepts

### Description of the model

$$
\begin{equation}
\mu_{[i]} = \mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]} + VTL \cdot \mathrm{vtl}_{[i]} + VTL \colon C_{[\mathsf{C}_{[i]}]} \cdot \mathrm{vtl}_{[i]}
(\#eq:9-11)
\end{equation}
$$

$$
\begin{equation}
\mu_{[i]} = (\mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]}) + (VTL \cdot \mathrm{vtl}_{[i]} + VTL \colon C_{[\mathsf{C}_{[i]}]} \cdot \mathrm{vtl}_{[i]})
(\#eq:9-12)
\end{equation}
$$

$$
\begin{equation}
\mu_{[i]} = (\mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]}) + (VTL + VTL \colon C_{[\mathsf{C}_{[i]}]} ) \cdot \mathrm{vtl}_{[i]}
(\#eq:9-13)
\end{equation}
$$

$$
\begin{equation}
\begin{split}
\mu_{[i]} = a_{[i]} + b_{[i]} \cdot \mathrm{vtl}_{[i]}  \\
a_{[i]} = \mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]} \\
b_{[i]} = VTL + VTL \colon C_{[\mathsf{C}_{[i]}]}) 
\end{split}
(\#eq:9-14)
\end{equation}
$$

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{N}(\mu_{[i]},\sigma) \\
\mu_{[i]} = (\mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]}) + (VTL \cdot \mathrm{vtl}_{[i]} + VTL \colon C_{[\mathsf{C}_{[i]}]} \cdot \mathrm{vtl}_{[i]}) \\ \\
\textrm{Priors:} \\
\mathrm{Intercept} \sim \mathrm{t}(3, 160, 12) \\
VTL \sim \mathrm{t}(3, 0, 12) \\ 
C_{[\bullet]} \sim \mathrm{t}(3, 0, 12) \\ 
VTL\colon C_{[\bullet]} \sim \mathrm{t}(3, 0, 12) \\ 
\sigma \sim \mathrm{t}(3, 0, 12)
\end{split}
(\#eq:9-15)
\end{equation}
$$

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{N}(\mu_{[i]},\sigma) \\
\mu_{[i]} = a_{[i]} + b_{[i]} \cdot \mathrm{vtl}_{[i]}  \\
a_{[i]} = \mathrm{Intercept} + C_{[\mathsf{C}_{[i]}]} \\
b_{[i]} = VTL + VTL \colon C_{[\mathsf{C}_{[i]}]} \\\\
\textrm{Priors:} \\
\mathrm{Intercept} \sim \mathrm{t}(3, 160, 12) \\
VTL \sim \mathrm{t}(3, 0, 12) \\ 
C_{[\bullet]} \sim \mathrm{t}(3, 0, 12) \\ 
VTL\colon C_{[\bullet]} \sim \mathrm{t}(3, 0, 12) \\ 
\sigma \sim \mathrm{t}(3, 0, 12)
\end{split}
(\#eq:9-16)
\end{equation}
$$

### Fitting and interpreting the model {#c9-fitting-3}

```{r, eval = FALSE}
# Fit the model yourself
options (contrasts = c('contr.sum','contr.sum'))
model_multi_slope =
  brm (height ~ C + vtl + vtl:C, 
       data=exp_data, chains=1,cores=1,warmup=1000,iter=6000,
       prior = c(set_prior("student_t(3, 160, 12)", class = "Intercept"),
                 set_prior("student_t(3, 0, 12)", class = "b"),
                 set_prior("student_t(3, 0, 12)", class = "sigma")))
```
```{r, include = TRUE, eval = FALSE}
# Or download it from the GitHub page:
model_multi_slope = bmmb::get_model ('9_model_multi_slope.RDS')
```
```{r, include = FALSE}
# saveRDS (model_multi_slope, '../models/9_model_multi_slope.RDS')
model_multi_slope = readRDS ('../models/9_model_multi_slope.RDS')
```

```{r, collapse = TRUE}
# inspect fixed effects
brms::fixef (model_multi_slope)
```    

```{r, cache = TRUE, collapse = TRUE, echo = TRUE}
multi_slope_hypothesis = bmmb::short_hypothesis (
  model_multi_slope,
  hypothesis = 
    c("Intercept = 0",                       # overall intercept
      "Intercept + C1 = 0",                  # group 1 mean
      "Intercept + C2 = 0",                  # group 2 mean
      "Intercept + C3 = 0",                  # group 3 mean
      "Intercept + -(C1+C2+C3) = 0",         # group 4 mean
      "vtl = 0",                             # overall slope
      "vtl + C1:vtl = 0",                    # group 1 slope
      "vtl + C2:vtl = 0",                    # group 2 slope
      "vtl + C3:vtl = 0",                    # group 3 slope      
      "vtl + -(C1:vtl+C2:vtl+C3:vtl) = 0"))  # group 4 slope
```

```{r F9-5, fig.width = 8, fig.height = 2.75, echo = FALSE, fig.cap = "(left) Posterior means and 95% credible intervals for group-specific intercepts. (middle) Group-specific VTL slopes. (right) Lines for each speaker group based on the slopes and intercepts in the left and middle plots. Group colors match the other plots."}

################################################################################
### Figure 9.5
################################################################################

labs = c("boys","girls","men","women")

par (mfrow = c(1,3), mar = c(4,2,1,1), oma = c(0,3,0,0))

brmplot(multi_slope_hypothesis[2:5,],labels = labs, cex=2,cex.lab=1.3,cex.axis=1.3,
        col = bmmb::cols[c(2:5)], xlim = c(.75,4.25), ylim = c(148,173) )
abline (h = 0)

brmplot(multi_slope_hypothesis[7:10,],labels = labs,cex=2,cex.lab=1.3,cex.axis=1.3,
        col = bmmb::cols[c(2:5)], xlim = c(.75,4.25), ylim = c(-1,9.5))
abline (h = 0, lty = 3)

mtext (side = 2, outer = TRUE, line = 2.5, text = "")

multi_slope_coefficients = multi_slope_hypothesis[,1]

plot (height ~ vtl_c, data = exp_data, pch=16,col=cols_use,xlim = c(-2.5,3),
      ylim=c(100,200), ylab="",xlab="Centered VTL (cm)",cex.lab=1.3,cex.axis=1.3);
grid ()
for (i in 1:4) {
  abline (multi_slope_coefficients[i+1], 
          multi_slope_coefficients[i+6], col="grey10", lwd=6)
    abline (multi_slope_coefficients[i+1], 
          multi_slope_coefficients[i+6], col=bmmb::cols[c(2,3,4,5)][i], lwd=4)
}
abline (multi_slope_coefficients[1], 
        multi_slope_coefficients[6], lwd=2, lty=2)
mtext (side=2,outer=TRUE,"Centimeters", adj = 0.55, cex = 0.9, line = 1.5)
```

### Interpreting group effects in the presence of varying slopes

## Answering our research questions: Interim discussion
 
## Data and research questions: Updated

```{r, warning=FALSE, message=FALSE}
library (brms)
library (bmmb)

data (exp_data)

options (contrasts = c('contr.sum','contr.sum'))

# make a copy of the VTL predictor and center it
exp_data$vtl_original = exp_data$vtl
exp_data$vtl = exp_data$vtl - mean(exp_data$vtl)
```

## Models with intercepts and slopes for each level of a grouping factor (i.e. 'random slopes')

### Description of the model

$$
\begin{equation}
\begin{split}
height_{[i]} \sim \mathrm{t}(\nu, \mu_{[i]},\sigma) \\ 
\mu_{[i]} = a +  b \cdot \mathrm{vtl}_{[i]} \\
a_{[i]} = \mathrm{Intercept} +  L_{[\mathsf{L}_{[i]}]} + S_{[\mathsf{S}_{[i]}]} \\ 
b_{[i]} = VTL + VTL \colon L_{[\mathsf{L}_{[i]}]}  \\ \\
\mathrm{Priors:} \\ 
S_{[\bullet]} \sim \mathrm{t}(3,0,\sigma_S) \\
\begin{bmatrix} L_{[\bullet]} \\ VTL \colon L_{[\bullet]} \end{bmatrix} \sim \mathrm{MVNormal} ( \begin{bmatrix} 0 \\ 0 \\ \end{bmatrix}, \mathrm{\Sigma}) \\ \\
\mathrm{Intercept} \sim \mathrm{t}(3,156,12) \\
VTL \sim \mathrm{t}(3,0,12) \\
\sigma_L, \sigma_{VTL \colon L}, \sigma_S \sim \mathrm{t}(3,0,12) \\
\sigma \sim \mathrm{t}(3,0,12) \\
\nu \sim \mathrm{gamma}(2, 0.1) \\ 
R \sim \mathrm{LKJCorr} (2)
\end{split}
(\#eq:9-17)
\end{equation}
$$

### Fitting and interpreting the model

```{r, eval = FALSE}
# Fit the model yourself
priors = c(brms::set_prior("student_t(3,160, 12)", class = "Intercept"),
           brms::set_prior("student_t(3,0, 12)", class = "b"),
           brms::set_prior("student_t(3,0, 12)", class = "sd"),
           brms::set_prior("lkj_corr_cholesky (2)", class = "cor"), 
           brms::set_prior("gamma(2, 0.1)", class = "nu"),
           brms::set_prior("student_t(3,0, 12)", class = "sigma"))

model_random_slopes_simple =  
  brms::brm (height ~ vtl + (vtl|L) + (1|S), data = exp_data, chains = 4, 
             cores = 4, warmup = 1000, iter = 5000, thin = 4, 
             prior = priors, family = "student")
```
```{r, include = TRUE, eval = FALSE}
# Or download it from the GitHub page:
model_random_slopes_simple = 
  bmmb::get_model ('9_model_random_slopes_simple.RDS')
```
```{r, include = FALSE}
##  saveRDS (model_random_slopes_simple, '../models/9_model_random_slopes_simple.RDS')
model_random_slopes_simple = 
  readRDS ('../models/9_model_random_slopes_simple.RDS')
```

```{r, eval = TRUE}
bmmb::short_summary(model_random_slopes_simple)
```

```{r}
bmmb::short_summary(model_single_line)
```

```{r}
# get listener effects
listener_effects = short_hypothesis(
  model_random_slopes_simple, c("Intercept = 0","vtl = 0"),
  scope = "ranef",group="L")
```

```{r}
# get 3rd and 18th row of our listener effects
# these are the intercept and slope effects for listener 3
listener_effects[c(3,18),]
```

```{r}
# get listener coefficients
listener_coefficients = short_hypothesis(
  model_random_slopes_simple, c("Intercept = 0","vtl = 0"),
  scope = "coef",group="L")
```

```{r}
# get 3rd and 18th row of our listener coefficients
# these are the intercept and slope coefficients for listener 3
listener_coefficients[c(3,18),]
```

```{r F9-6, fig.width = 8, fig.height = 5, fig.cap="Each plot shows responses from a single subject. The line with matched color represents the listener-specific line. The broken black line in each plot is the average 'main effects' line.", echo = FALSE, cache=FALSE}

################################################################################
### Figure 9.6
################################################################################

knitr::include_graphics("_main_files/figure-html/Figure 9.6.jpg")

# jpeg ("Figure 9.6.jpg",4800,3000,res=600)
# yaxts = c('s','n','n','n','n','s','n','n','n','n','s','n','n','n','n')
# xaxts = c('n','n','n','n','n','n','n','n','n','n','s','s','s','s','s')
# 
# cffs = brms::fixef(model_random_slopes_simple)[,1]
# par (mar = c(.25,.25,.25,.25), mfrow = c(3,5), oma = c(4.3,4.3,1,1))
# for (i in 1:15){
#   tmp = exp_data[exp_data$L == i,]
#   plot (height ~ vtl, data = tmp, col=bmmb::cols[i],pch=16,xlim=c(-3,3),
#         ylim=(c(100,200)),xlab="",ylab="",yaxt=yaxts[i],xaxt=xaxts[i])
#   #points (height ~ vtl, data = tmp, col=1)
#   #abline (lm(height ~ vtl, data = tmp)$coefficients, col=cols[i],lwd=4)
#   abline (listener_coefficients[i,1],listener_coefficients[i+15,1],
#           col=1,lwd=6, lty=1)
#   abline (listener_coefficients[i,1],listener_coefficients[i+15,1],
#           col=bmmb::cols[i],lwd=4, lty=1)
#   abline (cffs[1], cffs[2], lwd = 3,col=1, lty=2)
#   grid()
# }
# mtext (side = 1, outer = TRUE, text = "Centered vocal-tract length (cm)", line = 3)
# mtext (side = 2, outer = TRUE, text = "Apparent Height (cm)", line = 3)
# dev.off()
```

## Models with multiple predictors for each level of a grouping factor


### Description of the model

$$
\begin{equation}
\begin{aligned}
\mathrm{height}_{[i]} \sim \mathrm{t}(\nu, \mu_{[i]},\sigma) \\ 
\mu_{[i]} = a +  b \cdot \mathrm{vtl}_{[i]} \\
\\ a_{[i]} = \mathrm{Intercept} +  A + G + A \colon G + \\ A \colon L_{[\mathsf{L}_{[i]}]} + G \colon L_{[\mathsf{L}_{[i]}]} + A \colon G \colon L_{[\mathsf{L}_{[i]}]} + L_{[\mathsf{L}_{[i]}]} + S_{[\mathsf{S}_{[i]}]} \\ 
\\ b_{[i]} = VTL + VTL \colon A + VTL \colon G + VTL \colon A \colon G + \\ VTL \colon A \colon L_{[\mathsf{L}_{[i]}]}  +  VTL \colon G \colon L_{[\mathsf{L}_{[i]}]} + VTL \colon A \colon G \colon L_{[\mathsf{L}_{[i]}]} + VTL \colon L_{[\mathsf{L}_{[i]}]}  \\ \\
\mathrm{Priors:} \\ 
S_{[\bullet]} \sim \mathrm{t}(3,0,\sigma_S) \\
\begin{bmatrix} A \colon L_{[\bullet]} \\ G \colon L_{[\bullet]} \\ A \colon G \colon L_{[\bullet]} \\ L_{[\bullet]} \\
VTL \colon A \colon L_{[\bullet]} \\ VTL \colon G \colon L_{[\bullet]} \\ VTL \colon A \colon G \colon L_{[\bullet]} \\ VTL \colon L_{[\bullet]}
\end{bmatrix} \sim \mathrm{MVNormal} \left( \begin{bmatrix} 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ 0 \\ \end{bmatrix}, \mathrm{\Sigma} \right) \\\\
\ldots
\end{aligned}
(\#eq:9-18)
\end{equation}
$$

### Fitting and interpreting the model {#c9-fitting-5}

Below we fit our 'complex' model. 

```{r, eval = FALSE}
# Fit the model yourself
priors = c(brms::set_prior("student_t(3,160, 12)", class = "Intercept"),
           brms::set_prior("student_t(3,0, 12)", class = "b"),
           brms::set_prior("student_t(3,0, 12)", class = "sd"),
           brms::set_prior("lkj_corr_cholesky (2)", class = "cor"), 
           brms::set_prior("gamma(2, 0.1)", class = "nu"),
           brms::set_prior("student_t(3,0, 12)", class = "sigma"))

model_random_slopes_complex =  
  brms::brm (height ~ vtl*A*G + (vtl*A*G|L) + (1|S), data = exp_data, 
             chains = 4, cores = 4, warmup = 1000, iter = 5000, thin = 4, 
             prior = priors, family = "student")
```
```{r, include = TRUE, eval = FALSE}
# Or download it from the GitHub page:
model_random_slopes_complex = 
  bmmb::get_model ('9_model_random_slopes_complex.RDS')
```
```{r, include = FALSE}
##  saveRDS (model_random_slopes_complex, '../models/9_model_random_slopes_complex.RDS')
model_random_slopes_complex = 
  readRDS ('../models/9_model_random_slopes_complex.RDS')
```

```{r, eval = FALSE}
bmmb::short_summary (model_random_slopes_complex)
```

```{r}
# model fixed effects
fixef_effects = brms::fixef (model_random_slopes_complex)

# model random effect standard deviations
sds = bmmb::get_sds (model_random_slopes_complex)

# model random effect correlations
correlations = bmmb::get_corrs (model_random_slopes_complex, factor="L")
```

```{r F9-7, fig.width = 8, fig.height = 3, fig.cap="(left) Estimates and 95% credible intervals for model fixed effects for `model_random_slopes_complex`. (middle) Standard deviation estimates and 95% credible intervals for listener-dependent random effects parameters, and the error. (right) Estimates and 95% credible intervals for listener random effects correlations.", echo = FALSE, cache=FALSE}

################################################################################
### Figure 9.7
################################################################################

par (mfrow = c(1,3), mar = c(10,2,1,1), oma = c(0,3,0,0))
bmmb::brmplot (fixef_effects[-1,], las = 2, ylim = c(-3,10),cex.lab=1.3,cex.axis=1.3)
bmmb::brmplot (sds, las = 2, ylim = c(0,10.5), yaxs='i',cex.lab=1.3,cex.axis=1.3)
bmmb::brmplot (correlations, las = 2, ylim = c(-1,1), yaxs='i',cex.lab=1.3,cex.axis=1.3)
mtext (side=2,outer=TRUE,line=1.5,"Centimeters", adj = 0.75)
```

```{r, cache = TRUE, collapse = TRUE, eval = TRUE, echo = FALSE}
random_slopes_complex_hypothesis = bmmb::short_hypothesis (
  model_random_slopes_complex,
  hypothesis = 
    c("Intercept - A1 - G1 + A1:G1 = 0",         # group 1 mean
      "Intercept - A1 + G1 - A1:G1 = 0",         # group 2 mean
      "Intercept + A1 - G1 - A1:G1 = 0",         # group 3 mean
      "Intercept + A1 + G1 + A1:G1 = 0",         # group 4 mean
      "vtl - vtl:A1 - vtl:G1 + vtl:A1:G1 = 0",   # group 1 slope
      "vtl - vtl:A1 + vtl:G1 - vtl:A1:G1 = 0",   # group 2 slope
      "vtl + vtl:A1 - vtl:G1 - vtl:A1:G1 = 0",   # group 3 slope      
      "vtl + vtl:A1 + vtl:G1 + vtl:A1:G1 = 0"))  # group 4 slope
```

```{r, cache = TRUE, collapse = TRUE}
random_slopes_complex_hypothesis_listener = bmmb::short_hypothesis (
  model_random_slopes_complex,
  hypothesis = 
    c("Intercept - A1 - G1 + A1:G1 = 0",         # group 1 mean
      "Intercept - A1 + G1 - A1:G1 = 0",         # group 2 mean
      "Intercept + A1 - G1 - A1:G1 = 0",         # group 3 mean
      "Intercept + A1 + G1 + A1:G1 = 0",         # group 4 mean
      "vtl - vtl:A1 - vtl:G1 + vtl:A1:G1 = 0",   # group 1 slope
      "vtl - vtl:A1 + vtl:G1 - vtl:A1:G1 = 0",   # group 2 slope
      "vtl + vtl:A1 - vtl:G1 - vtl:A1:G1 = 0",   # group 3 slope      
      "vtl + vtl:A1 + vtl:G1 + vtl:A1:G1 = 0"),  # group 4 slope  
  scope = "coef",group="L")
```

```{r F9-8, fig.width = 8, fig.height = 5, fig.cap="Each plot shows responses from a single subject. Lines indicate listener-specific relationships between VTL and apparent height for each speaker category.", echo = FALSE, cache=TRUE}

################################################################################
### Figure 9.8
################################################################################

knitr::include_graphics("_main_files/figure-html/Figure 9.8.jpg")

# jpeg ("../wrong_plots/Figure 9.8.jpg",4800,3000,res=600)
# par (mar = c(.25,.25,.25,.25), mfrow = c(3,5), oma = c(4.3,4.3,1,1))
# yaxts = c('s','n','n','n','n','s','n','n','n','n','s','n','n','n','n')
# xaxts = c('n','n','n','n','n','n','n','n','n','n','s','s','s','s','s')
# 
# for (i in 1:15){
#   tmp = exp_data[exp_data$L == i,]
#   cols_use = bmmb::cols[as.numeric(factor(tmp$C))+1]
# 
#   plot (height ~ vtl, data = tmp, pch=16,col=cols_use,xlim = c(-2.8,3),
#         ylim=c(100,200), xlab="",cex.lab=1.3,
#         yaxt=yaxts[i], xaxt=xaxts[i])
# 
#   #cffs = lm(height ~ vtl*C, data = tmp)$coefficients
#   #cffs = c(cffs[1:5], -sum(cffs[3:5]), cffs[6:8], -sum(cffs[6:8]))
#   #abline (cffs[1]+cffs[3],cffs[2]+cffs[7],col=cols[2],lwd=4);
#   #abline (cffs[1]+cffs[4],cffs[2]+cffs[8],col=cols[3],lwd=4);
#   #abline (cffs[1]+cffs[5],cffs[2]+cffs[9],col=cols[4],lwd=4);
#   #abline (cffs[1]+cffs[6],cffs[2]+cffs[10],col=cols[5],lwd=4);
# 
#   cffs = random_slopes_complex_hypothesis_listener[,1]
#   abline (cffs[i+0],cffs[i+60],col=bmmb::cols[2],lwd=3);
#   abline (cffs[i+15],cffs[75],col=bmmb::cols[3],lwd=3);
#   abline (cffs[i+30],cffs[90],col=bmmb::cols[4],lwd=3);
#   abline (cffs[i+45],cffs[105],col=bmmb::cols[5],lwd=3);
#   grid()
# }
# mtext (side = 1, outer = TRUE, text = "Centered VTL (cm)", line = 3)
# mtext (side = 2, outer = TRUE, text = "Apparent Height (cm)", line = 3)
# dev.off()
```

### Model selection 

```{r, cache = TRUE}
model_multi_slope = 
  brms::add_criterion(model_multi_slope,"loo")

model_random_slopes_simple = 
  brms::add_criterion(model_random_slopes_simple,"loo")

model_random_slopes_complex =
  brms::add_criterion(model_random_slopes_complex,"loo")
```

```{r}
loo_compare (model_multi_slope, 
             model_random_slopes_simple, 
             model_random_slopes_complex)
```

```{r, cache = TRUE}
bmmb::r2_bayes(model_multi_slope)

bmmb::r2_bayes(model_random_slopes_simple)

bmmb::r2_bayes(model_random_slopes_complex)
```

## Answering our research questions: Updated

```{r F9-9, fig.width = 8, fig.height = 2.75, fig.cap="(left) Group-specific intercepts from `model_random_slopes_complex`. (mid-left) Difference between group specific intercepts (i.e. intercept simple effects). (mid-right) Group-specific slopes from `model_random_slopes_complex`. (right) Difference between group specific slopes (i.e. slope simple effects).", echo = FALSE, cache=FALSE}

################################################################################
### Figure 9.9
################################################################################

simple_effects = bmmb::short_hypothesis (
  model_random_slopes_complex,
  hypothesis = 
    c("2*(A1 + A1:G1) = 0",   # age difference for women
      "2*(A1 - A1:G1) = 0",   # age difference for men 
      "2*(G1 + A1:G1) = 0",   # gender difference for adults 
      "2*(G1 - A1:G1) = 0",   # gender difference for children 
      "2*(vtl:A1 + vtl:A1:G1) = 0",  # VTL difference by age for women
      "2*(vtl:A1 - vtl:A1:G1) = 0",  # VTL difference by age for men
      "2*(vtl:G1 + vtl:A1:G1) = 0",  # VTL difference by gender for adults
      "2*(vtl:G1 - vtl:A1:G1) = 0")) # VTL difference by gender for children

par (mfrow = c(1,4), mar = c(4,3,.5,0.2), oma = c(.1,1.2,.1,.1))
bmmb::brmplot (random_slopes_complex_hypothesis[1:4,], las = 1,cex.lab=1.3,
               cex.axis=1.3, lab = c("b","g","m","w"), col = bmmb::cols[2:5])
bmmb::brmplot (simple_effects[1:4,], las = 2,cex.lab=1.3,cex.axis=1.3,
               lab = c("w-g","m-b","w-m","g-b"), col = bmmb::cols[6:9])

bmmb::brmplot (random_slopes_complex_hypothesis[5:8,], las = 1,cex.lab=1.3,
               cex.axis=1.3, lab = c("b","g","m","w"), col = bmmb::cols[2:5])
bmmb::brmplot (simple_effects[5:8,], las = 2,cex.lab=1.3,cex.axis=1.3,
               lab = c("w-g","m-b","w-m","g-b"), col = bmmb::cols[6:9])
mtext (side = 2, outer = TRUE, "Centimeters",adj = .6, cex=0.9)

```

```{r, cache = TRUE, collapse = TRUE}
simple_effects = bmmb::short_hypothesis (
  model_random_slopes_complex,
  hypothesis = 
    c("2*(A1 + A1:G1) = 0",          # age difference for women
      "2*(A1 - A1:G1) = 0",          # age difference for men 
      "2*(G1 + A1:G1) = 0",          # gender difference for adults 
      "2*(G1 - A1:G1) = 0",          # gender difference for children 
      "2*(vtl:A1 + vtl:A1:G1) = 0",  # VTL difference by age for women
      "2*(vtl:A1 - vtl:A1:G1) = 0",  # VTL difference by age for men
      "2*(vtl:G1 + vtl:A1:G1) = 0",  # VTL difference by gender for adults
      "2*(vtl:G1 - vtl:A1:G1) = 0")) # VTL difference by gender for children
```

```{r T9-1}
knitr::kable (simple_effects, caption="Information regarding estimated simple effects for `model_random_slopes_complex` calculated in `simple_effects`.", digits = 2)
```

### A word on causality

## Exercises

## References

## Plot Code

```{r , echo = FALSE}
labs = knitr::all_labels()
labs = labs[grep ("F", labs)]
```

```{r , ref.label=labs, eval=FALSE}
```

